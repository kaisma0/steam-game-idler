name: Build and Release

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for release (e.g. v1.0.0)'
        required: true
        default: 'manual-release'

jobs:
  build-and-release:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: latest

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Build .NET libraries
        run: MSBuild.exe .\libs\SteamUtility.csproj
        shell: pwsh

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Bump version in tauri.conf.json
        run: |
          $version = "${{ github.event.inputs.tag_name }}" -replace '^v', ''
          $tauriConfPath = "src-tauri/tauri.conf.json"
          
          # Read, replace version, and write back
          $json = Get-Content $tauriConfPath -Raw
          $json = $json -replace '"version": ".*?"', """version"": ""$version"""
          $json | Set-Content $tauriConfPath
          
          Write-Host "Bumped tauri.conf.json version to $version"
        shell: pwsh

      - name: Build Tauri app
        run: |
          $env:NEXT_TELEMETRY_DISABLED = "1"
          pnpm tauri build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STEAM_API_KEY: ${{ secrets.STEAM_API_KEY }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Prepare portable executable
        run: |
          $portableDir = "./portable-package"
          New-Item -ItemType Directory -Force -Path $portableDir
          
          # Copy the executable
          Copy-Item "./src-tauri/target/release/Steam Game Idler.exe" -Destination "$portableDir/Steam Game Idler.exe"
          
          # Copy the sidecar
          Copy-Item "./src-tauri/bin/SteamGameFetcher-x86_64-pc-windows-msvc.exe" -Destination "$portableDir/SteamGameFetcher.exe"
          
          # Copy the libs folder
          Copy-Item "./src-tauri/libs" -Destination "$portableDir/libs" -Recurse -Force
          
          # Create the portable zip
          Compress-Archive -Path "$portableDir/*" -DestinationPath "./src-tauri/target/release/Steam Game Idler_${{ github.event.inputs.tag_name }}_x64-portable.zip" -Force
          
          # Clean up temporary directory
          Remove-Item -Recurse -Force $portableDir
        shell: pwsh

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: ${{ github.event.inputs.tag_name }}
          name: Release ${{ github.event.inputs.tag_name }}
          body: "New Release"
          draft: false
          prerelease: false
          files: |
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/nsis/*.zip

            src-tauri/target/release/*-portable.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update latest.json for auto-updater
        if: success()
        run: |
          $version = "${{ github.event.inputs.tag_name }}" -replace '^v', ''
          
          # Read the signature from the .sig file generated by tauri build
          $sigFile = Get-ChildItem -Path "./src-tauri/target/release/bundle/nsis/*.nsis.zip.sig" | Select-Object -First 1
          $signature = Get-Content $sigFile.FullName -Raw
          $signature = $signature.Trim()
          
          # Get the correct filename from the signature file (remove .sig)
          $zipName = $sigFile.Name.Replace(".sig", "")
          # Replace spaces with dots to match actual release filenames
          $urlZipName = $zipName.Replace(" ", ".")
          
          # Build the download URL
          $url = "https://github.com/kaisma0/steam-game-idler/releases/download/${{ github.event.inputs.tag_name }}/$urlZipName"
          
          # Create the latest.json content
          $latestJson = @{
            version = $version
            major = $false
            notes = "Release ${{ github.event.inputs.tag_name }}"
            platforms = @{
              "windows-x86_64" = @{
                signature = $signature
                url = $url
              }
            }
          } | ConvertTo-Json -Depth 4
          
          # Write to file
          $latestJson | Out-File -FilePath "./latest.json" -Encoding utf8 -NoNewline
          
          Write-Host "Updated latest.json with version: $version"
          Write-Host "Signature: $signature"
          Write-Host "URL: $url"
        shell: pwsh

      - name: Commit and push latest.json
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add latest.json
          git commit -m "chore: update latest.json for ${{ github.event.inputs.tag_name }}"
          git push origin HEAD:main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ALLOW_MAIN_COMMIT: "1"